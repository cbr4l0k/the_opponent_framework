version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Ollama Configuration
      # Use host.docker.internal for Docker Desktop (Mac/Windows)
      # Use 172.17.0.1 for Linux (default Docker bridge)
      # Or set OLLAMA_BASE_URL in .env to override
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1}

      # ChromaDB Configuration
      - CHROMA_PERSIST_DIR=/app/data/chroma
      - CHROMA_COLLECTION=${CHROMA_COLLECTION:-obsidian_notes}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}

      # Vault Configuration
      - VAULT_PATH=${VAULT_PATH:-/obsidian}

      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173,http://localhost:3000}

      # RAG Configuration
      - CHUNK_SIZE=${CHUNK_SIZE:-512}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-50}
      - TOP_K_RESULTS=${TOP_K_RESULTS:-5}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Persist ChromaDB data
      - ./backend/data:/app/data
      # Mount Obsidian vault (read-only)
      # Set VAULT_PATH in .env or use default ./obsidian_vault
      - ${VAULT_PATH_HOST:-./obsidian_vault}:/obsidian:ro
    env_file:
      - ./backend/.env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - opponent-network

networks:
  opponent-network:
    driver: bridge
